var SSE=function(b,a){if(!(this instanceof SSE)){return new SSE(b,a)}this.INITIALIZING=-1;this.CONNECTING=0;this.OPEN=1;this.CLOSED=2;this.url=b;a=a||{};this.headers=a.headers||{};this.payload=a.payload!==undefined?a.payload:"";this.method=a.method||(this.payload&&"POST"||"GET");this.FIELD_SEPARATOR=":";this.listeners={};this.xhr=null;this.readyState=this.INITIALIZING;this.progress=0;this.chunk="";this.addEventListener=function(c,d){if(this.listeners[c]===undefined){this.listeners[c]=[]}if(this.listeners[c].indexOf(d)===-1){this.listeners[c].push(d)}};this.removeEventListener=function(d,e){if(this.listeners[d]===undefined){return}var c=[];this.listeners[d].forEach(function(f){if(f!==e){c.push(f)}});if(c.length===0){delete this.listeners[d]}else{this.listeners[d]=c}};this.dispatchEvent=function(d){if(!d){return true}d.source=this;var c="on"+d.type;if(this.hasOwnProperty(c)){this[c].call(this,d);if(d.defaultPrevented){return false}}if(this.listeners[d.type]){return this.listeners[d.type].every(function(e){e(d);return !d.defaultPrevented})}return true};this._setReadyState=function(d){var c=new CustomEvent("readystatechange");c.readyState=d;this.readyState=d;this.dispatchEvent(c)};this._onStreamFailure=function(c){this.dispatchEvent(new CustomEvent("error"));this.close()};this._onStreamProgress=function(d){if(this.xhr.status!==200){this._onStreamFailure(d);return}if(this.readyState==this.CONNECTING){this.dispatchEvent(new CustomEvent("open"));this._setReadyState(this.OPEN)}var c=this.xhr.responseText.substring(this.progress);this.progress+=c.length;c.split(/(\r\n|\r|\n){2}/g).forEach(function(e){if(e.trim().length===0){this.dispatchEvent(this._parseEventChunk(this.chunk.trim()));this.chunk=""}else{this.chunk+=e}}.bind(this))};this._onStreamLoaded=function(c){this._onStreamProgress(c);this.dispatchEvent(this._parseEventChunk(this.chunk));this.chunk=""};this._parseEventChunk=function(c){if(!c||c.length===0){return null}var f={id:null,retry:null,data:"",event:"message"};c.split(/\n|\r\n|\r/).forEach(function(e){e=e.trimRight();var g=e.indexOf(this.FIELD_SEPARATOR);if(g<=0){return}var i=e.substring(0,g);if(!(i in f)){return}var h=e.substring(g+1).trimLeft();if(i==="data"){f[i]+=h}else{f[i]=h}}.bind(this));var d=new CustomEvent(f.event);d.data=f.data;d.id=f.id;return d};this._checkStreamClosed=function(){if(this.xhr.readyState===XMLHttpRequest.DONE){this._setReadyState(this.CLOSED)}};this.stream=function(){this._setReadyState(this.CONNECTING);this.xhr=new XMLHttpRequest();this.xhr.addEventListener("progress",this._onStreamProgress.bind(this));this.xhr.addEventListener("load",this._onStreamLoaded.bind(this));this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this));this.xhr.addEventListener("error",this._onStreamFailure.bind(this));this.xhr.addEventListener("abort",this._onStreamFailure.bind(this));this.xhr.open(this.method,this.url);for(var c in this.headers){this.xhr.setRequestHeader(c,this.headers[c])}this.xhr.send(this.payload)};this.close=function(){if(this.readyState===this.CLOSED){return}this.xhr.abort();this.xhr=null;this._setReadyState(this.CLOSED)}};if(typeof exports!=="undefined"){exports.SSE=SSE};